<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="screen-orientation" content="portrait">
  <meta name="theme-color" content="#4F46E5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Spraff">
  <title>Spraff</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%234F46E5'/><text x='50' y='68' text-anchor='middle' font-family='system-ui' font-size='50' font-weight='900' fill='white'>S</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%234F46E5'/><text x='90' y='122' text-anchor='middle' font-family='system-ui' font-size='90' font-weight='900' fill='white'>S</text></svg>">
  <link rel="manifest" href="/manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,700;12..96,800&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/src/style.css">
  <!-- VAD Library for continuous chat mode -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.js"></script>
  <script>
    // Configure ONNX Runtime WASM paths before VAD loads
    // This prevents "Failed to resolve module specifier" errors from CDN loading
    ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/';
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.19/dist/bundle.min.js"></script>
</head>
<body>
  <!-- Landscape Warning -->
  <div class="landscape-warning">
    <svg viewBox="0 0 24 24">
      <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
      <line x1="12" y1="18" x2="12" y2="18.01"/>
    </svg>
    <p>Please rotate your device to portrait mode</p>
  </div>

  <!-- Cost Modal -->
  <div class="modal-overlay hidden" id="costModal">
    <div class="modal modal-small">
      <div class="modal-header">
        <h3>Cost</h3>
        <button class="modal-close" id="costModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <div class="cost-stats">
          <div class="cost-stat">
            <span class="cost-stat-label">OpenRouter balance</span>
            <span class="cost-stat-value" id="costBalance">—</span>
          </div>
          <div class="cost-stat">
            <span class="cost-stat-label">Last message</span>
            <span class="cost-stat-value" id="costLast">—</span>
          </div>
          <div class="cost-stat">
            <span class="cost-stat-label">This session</span>
            <span class="cost-stat-value" id="costSession">$0.00</span>
          </div>
          <div class="cost-stat" id="voiceSizeStat" style="display: none;">
            <span class="cost-stat-label">Last voice message</span>
            <span class="cost-stat-value" id="costVoiceSize">—</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div class="modal-overlay hidden" id="aboutModal">
    <div class="modal modal-small">
      <div class="modal-header">
        <h3>About</h3>
        <button class="modal-close" id="aboutModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1rem;">Simple, private AI chat.</p>
        <p style="margin-bottom: 1rem;">
          <a href="https://github.com/martinpllu/spraff" target="_blank" style="color: var(--link); text-decoration: none; font-weight: 600;">GitHub</a>
        </p>
        <p style="color: var(--fg-muted);">
          Created by <a href="https://www.linkedin.com/in/martin-pllu-7034513" target="_blank" style="color: var(--link); text-decoration: none;">Martin Pllu</a>
        </p>
        <p style="color: var(--fg-muted); font-size: 0.8rem; margin-top: 1rem;">Version: 29c98b</p>
      </div>
    </div>
  </div>

  <!-- Debug Modal - Full Screen -->
  <div class="modal-overlay hidden" id="debugModal" onclick="if(event.target===this)this.classList.add('hidden')" style="padding: 0;">
    <div class="modal" style="width: 100%; height: 100%; max-width: 100%; max-height: 100%; border-radius: 0; margin: 0;">
      <div class="modal-header">
        <h3>Debug Console</h3>
        <button class="modal-close" id="debugModalClose" onclick="document.getElementById('debugModal').classList.add('hidden')">&times;</button>
      </div>
      <div class="modal-body" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
        <div id="debugLog" style="font-family: monospace; font-size: 0.85rem; flex: 1; overflow-y: auto; background: var(--surface); padding: 0.75rem; border-radius: 4px; white-space: pre-wrap; word-break: break-all; line-height: 1.4;"></div>
        <button id="debugClearBtn" onclick="window.debugLogs.length=0;document.getElementById('debugLog').textContent='Cleared';" style="margin-top: 0.5rem; padding: 0.75rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 4px;">Clear</button>
      </div>
    </div>
  </div>

  <!-- Early debug script - runs before app.js -->
  <script>
    window.debugLogs = [];
    window.dbg = function(msg) {
      var time = new Date().toLocaleTimeString();
      var entry = '[' + time + '] ' + msg;
      window.debugLogs.push(entry);
      var el = document.getElementById('debugLog');
      if (el) el.textContent = window.debugLogs.join('\n');
    };
    window.onerror = function(msg, src, line, col) {
      window.dbg('ERROR: ' + msg + ' at ' + src + ':' + line + ':' + col);
      return false;
    };
    window.dbg('Debug initialized');
  </script>

  <!-- Privacy Modal -->
  <div class="modal-overlay hidden" id="privacyModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Privacy Policy</h3>
        <button class="modal-close" id="privacyModalClose">&times;</button>
      </div>
      <div class="modal-body" style="line-height: 1.7;">
        <p style="margin-bottom: 1rem;">There's no backend — it's just a static HTML file. Your conversations go through <a href="https://openrouter.ai" target="_blank" style="color: var(--accent);">OpenRouter</a> to Gemini on Google Vertex with <a href="https://openrouter.ai/docs/guides/features/zdr" target="_blank" style="color: var(--accent);">Zero Data Retention</a> enabled.</p>
        <p style="margin-bottom: 1rem;"><strong>How your data flows:</strong></p>
        <ul style="margin-bottom: 1rem; padding-left: 1.5rem;">
          <li style="margin-bottom: 0.5rem;"><strong>This app</strong> — No backend, no data collection. Your current conversation and any pending voice upload are stored in your browser's local storage so they persist if you switch apps or refresh. This data is cleared when you log out or start a new chat.</li>
          <li style="margin-bottom: 0.5rem;"><strong>OpenRouter</strong> — No conversation content stored, just metadata (timestamps, usage).</li>
          <li style="margin-bottom: 0.5rem;"><strong>Google Vertex</strong> — Zero Data Retention — prompts and responses aren't stored or logged.</li>
        </ul>
        <p style="color: var(--fg-muted);">Your OpenRouter API key is also stored in local storage so you don't have to log in every time. You can clear all local data by logging out.</p>
      </div>
    </div>
  </div>

  <!-- iOS Install Modal -->
  <div class="modal-overlay hidden" id="installModal">
    <div class="modal modal-small">
      <div class="modal-header">
        <h3>Install App</h3>
        <button class="modal-close" id="installModalClose">&times;</button>
      </div>
      <div class="modal-body" style="line-height: 1.7;">
        <p style="margin-bottom: 1rem;">To install Spraff on your device:</p>
        <ol style="margin-bottom: 1rem; padding-left: 1.5rem;">
          <li style="margin-bottom: 0.5rem;">Tap the <strong>Share</strong> button in Safari</li>
          <li style="margin-bottom: 0.5rem;">Scroll down and tap <strong>Add to Home Screen</strong></li>
          <li style="margin-bottom: 0.5rem;">Tap <strong>Add</strong> to confirm</li>
        </ol>
        <p style="color: var(--fg-muted);">The app will then launch in full-screen mode without browser controls.</p>
      </div>
    </div>
  </div>

  <!-- Voice Settings Modal -->
  <div class="modal-overlay hidden" id="voiceModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Voice Settings</h3>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body">
        <div class="current-voice" id="currentVoice">
          <span class="current-voice-label">Current:</span>
          <span class="current-voice-name" id="currentVoiceName">None selected</span>
        </div>
        <div class="cloud-toggle">
          <label class="toggle-row">
            <span class="toggle-label">
              <span class="toggle-title">Cloud voices</span>
              <span class="toggle-desc">Higher quality, but text is sent to third party services</span>
            </span>
            <input type="checkbox" id="cloudVoicesToggle">
            <span class="toggle-switch"></span>
          </label>
        </div>
        <div class="voice-help" id="voiceHelp">
          <a class="voice-help-btn" href="https://github.com/martinpllu/spraff#voice-quality" target="_blank">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="1.5" fill="none">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            How to install better voices
          </a>
        </div>
        <div class="voice-list" id="voiceList"></div>
      </div>
    </div>
  </div>

  <!-- Login Screen -->
  <script>if(location.search.includes('code='))document.write('<style id="oauth-hide-login">.login-screen{display:none!important}</style>')</script>
  <div class="login-screen" id="loginScreen">
    <div class="logo">
      <svg width="220" height="80" viewBox="0 0 220 80">
        <defs>
          <linearGradient id="logo-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#4F46E5"/>
            <stop offset="100%" stop-color="#7C3AED"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="220" height="80" rx="24" fill="url(#logo-gradient)"/>
        <text x="110" y="54" text-anchor="middle" font-family="Bricolage Grotesque, sans-serif" font-size="42" font-weight="800" fill="white">spraff</text>
      </svg>
    </div>
    <p class="login-tagline">Simple AI chat</p>
    <button class="login-btn" id="loginBtn">Get started</button>
    <a class="login-about" href="https://github.com/martinpllu/spraff" target="_blank">About</a>
  </div>

  <!-- Main Voice Screen -->
  <div class="voice-screen hidden" id="voiceScreen">
    <!-- Top Menu -->
    <div class="top-menu" id="topMenu">
      <div class="settings-menu" id="settingsMenu">
        <button class="settings-menu-btn" id="settingsMenuBtn" title="Settings">
          spraff
          <svg viewBox="0 0 24 24" width="16" height="16">
            <circle cx="12" cy="5" r="1.5" fill="currentColor"/>
            <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
            <circle cx="12" cy="19" r="1.5" fill="currentColor"/>
          </svg>
        </button>
        <div class="settings-dropdown" id="settingsDropdown">
          <button id="voiceSettingsBtn">
            <svg viewBox="0 0 24 24">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
            </svg>
            Voice
          </button>
          <button id="costSettingsBtn">
            <svg viewBox="0 0 24 24">
              <line x1="12" y1="1" x2="12" y2="23"/>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            Cost
          </button>
          <button id="copyChatBtn">
            <svg viewBox="0 0 24 24">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
            Copy chat
          </button>
          <button id="installBtn" class="hidden">
            <svg viewBox="0 0 24 24">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Install app
          </button>
          <div class="divider"></div>
          <button id="aboutBtn">
            <svg viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="16" x2="12" y2="12"/>
              <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            About
          </button>
          <button id="privacyBtn">
            <svg viewBox="0 0 24 24">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            Privacy
          </button>
          <button id="debugBtn" onclick="document.getElementById('debugModal').classList.remove('hidden'); document.getElementById('settingsDropdown').classList.remove('open'); document.getElementById('debugLog').textContent = window.debugLogs ? window.debugLogs.join('\\n') : 'No logs';">
            <svg viewBox="0 0 24 24">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5"/>
              <path d="M2 12l10 5 10-5"/>
            </svg>
            Debug
          </button>
          <button id="logoutBtn">
            <svg viewBox="0 0 24 24">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
              <polyline points="16 17 21 12 16 7"/>
              <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Conversation History -->
    <div class="conversation-history" id="conversationHistory"></div>

    <!-- Text Input -->
    <div class="text-input-container" id="textInputContainer">
      <div class="text-input-wrapper">
        <textarea class="text-input" id="textInput" placeholder="Type your message..." rows="1"></textarea>
        <button class="text-send-btn" id="textSendBtn">
          <svg viewBox="0 0 24 24">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
          <div class="spinner-icon"></div>
        </button>
      </div>
    </div>

    <!-- The Button -->
    <div class="button-container">
      <button class="main-button" id="mainButton">
        <svg class="mic-icon" viewBox="0 0 24 24">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
          <line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
        <svg class="stop-icon" viewBox="0 0 24 24">
          <rect x="6" y="6" width="12" height="12" rx="1"/>
        </svg>
        <div class="spinner-icon"></div>
      </button>
      <div class="status-text" id="statusText">Ready</div>
    </div>

    <!-- Hint -->
    <div class="hint-text" id="hintText">
      Push button or <kbd>Space</kbd> to speak
    </div>

    <!-- Bleed detection status -->
    <div class="bleed-status" id="bleedStatus"></div>

    <!-- Bottom Bar - controls only -->
    <div class="bottom-bar" id="bottomBar">
      <div class="mode-toggle" id="modeToggle">
        <button class="mode-btn active" id="voiceModeBtn" title="Voice mode">
          <svg viewBox="0 0 24 24">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          </svg>
        </button>
        <button class="mode-btn" id="textModeBtn" title="Text mode">
          <svg viewBox="0 0 24 24">
            <path d="M4 7V4h16v3"/>
            <path d="M9 20h6"/>
            <path d="M12 4v16"/>
          </svg>
        </button>
      </div>
      <div class="bottom-bar-right">
        <button class="action-btn hidden" id="stopBtn">
          <svg viewBox="0 0 24 24">
            <rect x="6" y="6" width="12" height="12" rx="1"/>
          </svg>
          <span>Stop</span>
        </button>
        <button class="action-btn hidden" id="cancelBtn">
          <svg viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
          <span>Cancel</span>
        </button>
        <button class="action-btn hidden" id="exitContinuousBtn">
          <svg viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
          <span>Exit</span>
        </button>
        <button class="action-btn hidden" id="clearChatBtn">
          <span class="clear-chat-text">Clear</span>
          <span class="clear-chat-badge" id="clearChatBadge"></span>
        </button>
      </div>
    </div>
  </div>


  <div class="error-toast" id="errorToast"></div>

  <script type="module" src="/src/main.ts"></script>
  <script>window.dbg('After main.ts script tag');</script>
</body>
</html>
